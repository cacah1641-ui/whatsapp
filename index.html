<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Clone Private</title>
    <style>
        :root {
            --wa-bg: #e5ddd5;
            --wa-header: #075e54;
            --wa-sent: #dcf8c6;
            --wa-received: #ffffff;
            --wa-btn: #128c7e;
            --wa-accent: #06d755;
        }

        body { 
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif; 
            background: var(--wa-bg); 
            margin: 0; display: flex; flex-direction: column; height: 100vh; 
            overflow: hidden;
        }

        /* Password Overlay */
        #password-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:white; display:flex; flex-direction:column; 
            align-items:center; justify-content:center; z-index:4000; 
        }

        /* Full Screen Preview */
        #preview-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: none; flex-direction: column; z-index: 3000;
        }
        .preview-header { padding: 15px; display: flex; align-items: center; color: white; }
        .preview-body { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #preview-img { max-width: 100%; max-height: 70vh; object-fit: contain; }
        .preview-footer { 
            padding: 20px; background: rgba(0,0,0,0.8); 
            display: flex; align-items: center; gap: 10px; 
        }
        #caption-input { 
            flex: 1; background: #2a2f32; border: none; padding: 12px 18px; 
            border-radius: 25px; color: white; outline: none; font-size: 15px;
        }

        /* Header */
        #header { 
            background: var(--wa-header); color: white; padding: 10px 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10;
        }

        /* Chat Area */
        #chat-container { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; 
            flex-direction: column; gap: 10px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }

        .message { 
            padding: 8px 12px; border-radius: 8px; max-width: 85%; 
            position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            word-wrap: break-word; cursor: pointer;
        }
        .sent { align-self: flex-end; background: var(--wa-sent); }
        .received { align-self: flex-start; background: var(--wa-received); }

        /* Reply UI */
        .reply-box-in-chat {
            background: rgba(0,0,0,0.05); border-left: 4px solid var(--wa-accent);
            padding: 5px; border-radius: 4px; margin-bottom: 5px; font-size: 12px;
        }
        #reply-preview-bar {
            display: none; background: #f0f0f0; padding: 8px 15px;
            border-left: 5px solid var(--wa-accent); border-top: 1px solid #ddd;
        }

        /* Voice Note */
        .voice-note { display: flex; align-items: center; gap: 5px; }
        audio { height: 35px; width: 200px; }
        .recording { color: red !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* Input Area */
        #input-area { padding: 8px; background: #f0f0f0; display: flex; align-items: center; gap: 8px; }
        #msg-input { 
            flex: 1; padding: 10px 15px; border-radius: 25px; 
            border: none; outline: none; font-size: 15px; 
        }
        .circle-btn {
            background: var(--wa-btn); color: white; border: none;
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .icon-btn { background: none; border: none; font-size: 22px; color: #666; cursor: pointer; }
        
        .msg-footer { display: flex; justify-content: flex-end; font-size: 10px; color: #888; margin-top: 4px; }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2 style="color:var(--wa-header)">WhatsApp Private</h2>
        <input type="password" id="pass-input" placeholder="Masukkan Password" style="padding:10px; border-radius:8px; border:1px solid #ccc; width:220px; text-align:center;">
        <br>
        <button onclick="checkPassword()" class="circle-btn" style="width:100px; border-radius:20px;">MASUK</button>
    </div>

    <div id="preview-overlay">
        <div class="preview-header">
            <button onclick="cancelPreview()" class="icon-btn" style="color:white">‚úï</button>
            <span style="margin-left:15px; font-weight:bold;">Preview Foto</span>
        </div>
        <div class="preview-body">
            <img id="preview-img" src="">
        </div>
        <div class="preview-footer">
            <input type="text" id="caption-input" placeholder="Tambahkan keterangan...">
            <button class="circle-btn" onclick="confirmSendImage()">‚û§</button>
        </div>
    </div>

    <div id="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b id="room-name">Memuat...</b>
            <button onclick="clearChat()" style="background:none; border:none; color:white; font-size:12px;">Hapus Chat</button>
        </div>
        <span id="status-label" style="font-size:11px; opacity:0.8;">Menghubungkan...</span>
    </div>

    <div id="chat-container"></div>

    <div id="reply-preview-bar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="reply-text-node" style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
            <button onclick="cancelReply()" style="border:none; background:none; font-size:16px;">‚úï</button>
        </div>
    </div>

    <div id="input-area">
        <button class="icon-btn" onclick="document.getElementById('file-input').click()">üì∑</button>
        <input type="file" id="file-input" accept="image/*" style="display:none">
        
        <input type="text" id="msg-input" placeholder="Ketik pesan..." autocomplete="off">
        
        <button id="mic-btn" class="icon-btn" onclick="handleVoiceNote()">üìû</button>
        <button id="send-btn" class="circle-btn" onclick="handleSend()" style="display:none">‚û§</button>
    </div>

    <script>
        const PASS = "*123#"; 
        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room') || 'Utama';
        const myId = 'user_' + Math.random().toString(36).substr(2, 5);
        
        let renderedIds = new Set();
        let currentReply = null;
        let selectedFile = null;
        let mediaRecorder, audioChunks = [], isRecording = false;

        function checkPassword() {
            if (document.getElementById('pass-input').value === PASS) {
                document.getElementById('password-overlay').style.display = 'none';
                initApp();
            } else { alert("Password salah!"); }
        }

        // Logic Switch Phone Icon / Send Button
        document.getElementById('msg-input').addEventListener('input', (e) => {
            const hasText = e.target.value.trim().length > 0;
            document.getElementById('mic-btn').style.display = hasText ? 'none' : 'block';
            document.getElementById('send-btn').style.display = hasText ? 'flex' : 'none';
        });

        // Image Preview
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('preview-img').src = ev.target.result;
                document.getElementById('preview-overlay').style.display = 'flex';
                document.getElementById('caption-input').focus();
            };
            reader.readAsDataURL(file);
        });

        function cancelPreview() {
            selectedFile = null;
            document.getElementById('preview-overlay').style.display = 'none';
        }

        async function confirmSendImage() {
            const caption = document.getElementById('caption-input').value;
            const imgBase64 = await compressImage(selectedFile);
            sendData(caption, imgBase64, null);
            cancelPreview();
            document.getElementById('caption-input').value = '';
        }

        // Voice Note (Function tetap merekam meski ikonnya telepon)
        async function handleVoiceNote() {
            const btn = document.getElementById('mic-btn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => sendData(null, null, reader.result);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    btn.innerText = "‚è∫"; // Berubah jadi ikon rekam saat aktif
                    document.getElementById('msg-input').placeholder = "Sedang merekam suara...";
                } catch(err) { alert("Izinkan akses Mikrofon!"); }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerText = "üìû"; 
                document.getElementById('msg-input').placeholder = "Ketik pesan...";
            }
        }

        // Reply Logic
        function prepareReply(text, sender) {
            currentReply = { text: text.substring(0, 60), sender };
            document.getElementById('reply-text-node').innerHTML = `<b>${sender}</b><br>${currentReply.text}`;
            document.getElementById('reply-preview-bar').style.display = 'block';
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            currentReply = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }

        async function handleSend() {
            const val = document.getElementById('msg-input').value;
            if (!val.trim()) return;
            sendData(val, null, null);
            document.getElementById('msg-input').value = '';
            document.getElementById('send-btn').style.display = 'none';
            document.getElementById('mic-btn').style.display = 'block';
        }

        async function sendData(text, image, audio) {
            const payload = { room, text, image, audio, senderId: myId, reply: currentReply };
            try {
                await fetch('/api/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                cancelReply();
                fetchMessages();
            } catch (e) { console.error("Gagal mengirim data"); }
        }

        function append(msg) {
            const id = msg.id || (msg.senderId + (msg.text||'') + (msg.audio?'aud':'') + (msg.time||''));
            if (renderedIds.has(id)) return;
            renderedIds.add(id);

            const container = document.getElementById('chat-container');
            const isMe = msg.senderId === myId;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            div.onclick = () => prepareReply(msg.text || (msg.image?"Foto":"Suara"), isMe?"Anda":room);

            let content = "";
            if (msg.reply) {
                content += `<div class="reply-box-in-chat"><b>${msg.reply.sender}</b><br>${msg.reply.text}</div>`;
            }
            if (msg.audio) content += `<div class="voice-note"><audio controls src="${msg.audio}"></audio></div>`;
            if (msg.image) content += `<img src="${msg.image}" style="width:100%; border-radius:5px; margin-bottom:5px;">`;
            if (msg.text) content += `<div>${msg.text}</div>`;
            
            content += `<div class="msg-footer">${msg.time || new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${isMe?'‚úî‚úî':''}</div>`;
            
            div.innerHTML = content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function fetchMessages() {
            try {
                const res = await fetch(`/api/messages?room=${room}`);
                const data = await res.json();
                if (Array.isArray(data)) data.forEach(m => append(m));
            } catch (e) {}
        }

        async function compressImage(file) {
            return new Promise(res => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const max = 800;
                        let w = img.width, h = img.height;
                        if (w > h && w > max) { h *= max/w; w = max; }
                        else if (h > max) { w *= max/h; h = max; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        function initApp() {
            document.getElementById('room-name').innerText = room;
            document.getElementById('status-label').innerText = "üü¢ Online";
            fetchMessages();
            setInterval(fetchMessages, 2000);
        }

        async function clearChat() {
            if (confirm("Hapus semua chat?")) {
                await fetch(`/api/messages?room=${room}`, { method: 'DELETE' });
                location.reload();
            }
        }
    </script>
</body>
</html>