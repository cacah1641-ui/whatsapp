<!DOCTYPE html>
<html>
<head>
    <title>Chat Pribadi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #chat-box { height: 70vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; }
        .msg { margin: 5px; padding: 10px; border-radius: 10px; background: #e1ffc7; max-width: 80%; align-self: flex-start; }
        .msg img { max-width: 100%; border-radius: 5px; }
        .time { font-size: 10px; color: gray; display: block; }
    </style>
</head>
<body>
    <div id="chat-box"></div>
    
    <div style="padding: 10px;">
        <input type="text" id="textInput" placeholder="Ketik pesan...">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <button onclick="document.getElementById('fileInput').click()">ðŸ“·</button>
        <button onclick="send()">Kirim</button>
    </div>

    <script>
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const room = 'Utama';
        const myId = "User_" + Math.floor(Math.random() * 100);

        socket.emit('join-room', room);

        // Ambil data lama saat pertama buka
        fetch(`/api/messages?room=${room}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(msg => tampilkanPesan(msg));
                scrollBawah();
            });

        // Terima pesan baru (Real-time tanpa refresh)
        socket.on('new-message', (msg) => {
            tampilkanPesan(msg);
            scrollBawah();
        });

        async function send() {
            const text = document.getElementById('textInput').value;
            const file = document.getElementById('fileInput').files[0];
            let imageData = null;

            if (file) {
                const reader = new FileReader();
                imageData = await new Promise(resolve => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            if (text || imageData) {
                socket.emit('send-chat', {
                    room: room,
                    text: text,
                    image: imageData,
                    senderId: myId
                });
                document.getElementById('textInput').value = '';
                document.getElementById('fileInput').value = '';
            }
        }

        function tampilkanPesan(msg) {
            const div = document.createElement('div');
            div.className = 'msg';
            
            let html = `<b>${msg.senderId}</b><br>`;
            if (msg.text) html += `<span>${msg.text}</span><br>`;
            if (msg.image) html += `<img src="${msg.image}"><br>`;
            if (msg.audio) html += `<audio controls src="${msg.audio}"></audio><br>`;
            html += `<span class="time">${msg.time}</span>`;
            
            div.innerHTML = html;
            chatBox.appendChild(div);
        }

        function scrollBawah() { chatBox.scrollTop = chatBox.scrollHeight; }
    </script>
</body>
</html>
