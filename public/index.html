<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Clone</title>
    <style>
        :root {
            --wa-teal: #075e54;
            --wa-teal-light: #128c7e;
            --wa-bg: #e5ddd5;
            --wa-sent: #dcf8c6;
            --wa-received: #ffffff;
            --wa-accent: #34b7f1;
            --wa-gray: #f0f0f0;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; background: var(--wa-bg); height: 100vh; display: flex; flex-direction: column;
        }

        /* Header WhatsApp Style */
        header {
            background: var(--wa-teal); color: white; padding: 10px 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
        }
        .user-info b { font-size: 18px; display: block; }
        .user-info span { font-size: 12px; color: rgba(255,255,255,0.8); }

        /* Area Chat dengan Wallpaper */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 15px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat; display: flex; flex-direction: column; gap: 4px;
        }

        /* Bubble Chat Style */
        .message {
            max-width: 80%; padding: 6px 10px 8px 10px; border-radius: 8px;
            position: relative; font-size: 14.5px; line-height: 1.4;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); margin-bottom: 2px;
        }
        .sent { 
            align-self: flex-end; background: var(--wa-sent); 
            border-top-right-radius: 0; margin-right: 5px;
        }
        .received { 
            align-self: flex-start; background: var(--wa-received); 
            border-top-left-radius: 0; margin-left: 5px;
        }

        /* Bubble Tail (Ekor Bubble) */
        .message::before {
            content: ""; position: absolute; top: 0; width: 0; height: 0;
        }
        .sent::before {
            right: -8px; border: 8px solid transparent; border-top-color: var(--wa-sent);
        }
        .received::before {
            left: -8px; border: 8px solid transparent; border-top-color: var(--wa-received);
        }

        .msg-footer {
            display: flex; justify-content: flex-end; align-items: center;
            font-size: 11px; color: rgba(0,0,0,0.45); margin-top: 2px;
        }
        .sent .msg-footer .check { color: var(--wa-accent); margin-left: 3px; font-weight: bold; }

        /* Input Area WhatsApp Style */
        #input-area {
            background: #f0f0f0; padding: 7px 10px; display: flex; align-items: center; gap: 8px;
        }
        .input-wrapper {
            background: white; flex: 1; border-radius: 25px; display: flex; align-items: center; padding: 5px 12px;
        }
        #msg-input {
            flex: 1; border: none; outline: none; padding: 8px; font-size: 16px;
        }
        .circle-action {
            width: 45px; height: 45px; background: var(--wa-teal-light);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; border: none; cursor: pointer; font-size: 20px; flex-shrink: 0;
        }

        /* Preview Overlay */
        #preview-overlay {
            position: fixed; inset: 0; background: black; z-index: 2000;
            display: none; flex-direction: column;
        }
        #preview-img { flex: 1; object-fit: contain; width: 100%; max-height: 75vh; margin: auto; }
        .preview-footer { padding: 20px; display: flex; gap: 10px; }

        /* Password */
        #password-overlay {
            position: fixed; inset: 0; background: white; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        button { cursor: pointer; }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2 style="color:var(--wa-teal)">WhatsApp Private</h2>
        <input type="password" id="pass-input" placeholder="Password" style="padding:12px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">
        <button onclick="checkPassword()" class="circle-action" style="width:120px; border-radius:25px; font-size:16px;">MASUK</button>
    </div>

    <div id="preview-overlay">
        <div style="padding:15px; color:white; display:flex; align-items:center;">
            <button onclick="cancelPreview()" style="background:none; border:none; color:white; font-size:24px;">‚úï</button>
            <span style="margin-left:20px;">Kirim Foto</span>
        </div>
        <img id="preview-img" src="">
        <div class="preview-footer">
            <input type="text" id="caption-input" placeholder="Tambah keterangan..." style="flex:1; padding:12px; border-radius:25px; border:none;">
            <button class="circle-action" onclick="confirmSendImage()">‚û§</button>
        </div>
    </div>

    <header>
        <div class="user-info">
            <b id="room-name">Memuat...</b>
            <span id="status-label">Menghubungkan...</span>
        </div>
        <button onclick="clearChat()" style="background:none; border:none; color:white; font-size:13px;">HAPUS CHAT</button>
    </header>

    <div id="chat-container"></div>

    <div id="input-area">
        <div class="input-wrapper">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:20px; color:#666;">üì∑</button>
            <input type="file" id="file-input" accept="image/*" style="display:none">
            <input type="text" id="msg-input" placeholder="Ketik pesan...">
        </div>
        <button id="mic-btn" class="circle-action" onclick="handleVoiceNote()">üìû</button>
        <button id="send-btn" class="circle-action" onclick="handleSend()" style="display:none;">‚û§</button>
    </div>

    <script>
        const PASS = "*123#";
        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room') || 'Utama';
        const myId = 'user_' + Math.random().toString(36).substr(2, 5);

        let renderedIds = new Set();
        let selectedFile = null;
        let mediaRecorder, audioChunks = [], isRecording = false;

        function checkPassword() {
            if(document.getElementById('pass-input').value === PASS) {
                document.getElementById('password-overlay').style.display = 'none';
                initApp();
            } else { alert("Salah!"); }
        }

        // Switch button logic
        document.getElementById('msg-input').addEventListener('input', (e) => {
            const hasText = e.target.value.trim().length > 0;
            document.getElementById('mic-btn').style.display = hasText ? 'none' : 'flex';
            document.getElementById('send-btn').style.display = hasText ? 'flex' : 'none';
        });

        // Image logic
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('preview-img').src = ev.target.result;
                document.getElementById('preview-overlay').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        });

        function cancelPreview() {
            document.getElementById('preview-overlay').style.display = 'none';
            selectedFile = null;
        }

        async function confirmSendImage() {
            const caption = document.getElementById('caption-input').value;
            const reader = new FileReader();
            reader.readAsDataURL(selectedFile);
            reader.onload = async () => {
                await sendData(caption, reader.result, null);
                cancelPreview();
            }
        }

        // Voice Note logic
        async function handleVoiceNote() {
            const btn = document.getElementById('mic-btn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => sendData(null, null, reader.result);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    btn.innerHTML = "‚è∫";
                    btn.style.background = "red";
                } catch(e) { alert("Akses mic ditolak"); }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.innerHTML = "üìû";
                btn.style.background = "var(--wa-teal-light)";
            }
        }

        async function handleSend() {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            await sendData(input.value, null, null);
            input.value = '';
            document.getElementById('mic-btn').style.display = 'flex';
            document.getElementById('send-btn').style.display = 'none';
        }

        async function sendData(text, image, audio) {
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room, text, image, audio, senderId: myId })
            });
            fetchMessages();
        }

        function append(msg) {
            const id = msg.senderId + msg.time + (msg.text || '');
            if (renderedIds.has(id)) return;
            renderedIds.add(id);

            const container = document.getElementById('chat-container');
            const isMe = msg.senderId === myId;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            let html = "";
            if (msg.image) html += `<img src="${msg.image}" style="width:100%; border-radius:5px; margin-bottom:5px;">`;
            if (msg.audio) html += `<audio controls src="${msg.audio}" style="width:200px; height:30px;"></audio>`;
            if (msg.text) html += `<div>${msg.text}</div>`;
            
            html += `<div class="msg-footer">${msg.time} ${isMe ? '<span class="check">‚úì‚úì</span>' : ''}</div>`;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function fetchMessages() {
            const res = await fetch(`/api/messages?room=${room}`);
            const data = await res.json();
            data.forEach(m => append(m));
        }

        async function updateStatus() {
            const res = await fetch('/api/heartbeat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: myId, room })
            });
            const data = await res.json();
            document.getElementById('status-label').innerText = `${data.onlineCount} Orang Online`;
        }

        function initApp() {
            document.getElementById('room-name').innerText = room;
            setInterval(fetchMessages, 2000);
            setInterval(updateStatus, 5000);
            fetchMessages();
        }

        async function clearChat() {
            if(confirm("Hapus semua chat?")) {
                await fetch(`/api/messages?room=${room}`, { method: 'DELETE' });
                location.reload();
            }
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
