<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Real-time</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #chat-box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .msg { margin-bottom: 8px; padding: 5px; background: #f1f1f1; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Ketik pesan...">
    <button onclick="sendMessage()">Kirim</button>

    <script>
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const roomName = 'Utama'; // Sesuai default server Anda
        const myId = 'User_' + Math.floor(Math.random() * 1000);

        socket.emit('join-room', roomName);

        // 1. Load chat lama saat pertama kali buka (sekali saja)
        fetch(`/api/messages?room=${roomName}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(msg => appendMessage(msg));
                scrollToBottom();
            });

        // 2. Terima pesan baru via Socket (Real-time)
        socket.on('new-message', (msg) => {
            appendMessage(msg);
            scrollToBottom();
        });

        function sendMessage() {
            const input = document.getElementById('message-input');
            if(!input.value) return;

            const data = {
                room: roomName,
                text: input.value,
                senderId: myId
            };

            socket.emit('send-chat', data);
            input.value = '';
        }

        function appendMessage(msg) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<strong>${msg.senderId}:</strong> ${msg.text} <small>${msg.time}</small>`;
            chatBox.appendChild(div);
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
