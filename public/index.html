<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let currentUser = localStorage.getItem('chat_user') || 'User' + Math.floor(Math.random() * 1000);
    localStorage.setItem('chat_user', currentUser);

    const chatContainer = document.getElementById('chat-container');
    const room = 'Utama';

    // Join room saat koneksi berhasil
    socket.emit('join-room', room);

    // 1. Ambil data lama hanya saat pertama kali buka (Tidak kedap-kedip)
    async function loadInitialMessages() {
        const res = await fetch(`/api/messages?room=${room}`);
        const data = await res.json();
        chatContainer.innerHTML = ''; // Kosongkan hanya sekali di awal
        data.forEach(msg => renderMessage(msg));
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 2. Terima pesan baru dari Socket (Langsung nambah di bawah)
    socket.on('new-message', (msg) => {
        renderMessage(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });

    // 3. Fungsi Render (Sesuai gaya tampilan Anda sebelumnya)
    function renderMessage(msg) {
        const isMe = msg.senderId === currentUser;
        const div = document.createElement('div');
        div.className = `message ${isMe ? 'sent' : 'received'}`;
        
        let content = '';
        if (msg.text) content += `<div>${msg.text}</div>`;
        if (msg.image) content += `<img src="${msg.image}" style="max-width:100%; border-radius:8px; margin-top:5px;">`;
        if (msg.audio) content += `<audio controls src="${msg.audio}" style="width:100%; margin-top:5px;"></audio>`;
        
        div.innerHTML = `
            ${content}
            <div class="message-info">
                <span>${msg.senderId}</span>
                <span>${msg.time}</span>
            </div>
        `;
        chatContainer.appendChild(div);
    }

    // 4. Fungsi Kirim (Update untuk kirim lewat Socket)
    async function sendData(text, image, audio) {
        const data = {
            room: room,
            text: text,
            image: image,
            audio: audio,
            senderId: currentUser
        };
        socket.emit('send-chat', data);
    }

    // Jalankan load awal
    loadInitialMessages();

    // Fungsi pembantu kirim teks
    function sendMessage() {
        const inp = document.getElementById('msg-input');
        if (inp.value.trim()) {
            sendData(inp.value, null, null);
            inp.value = '';
        }
    }
</script>
