<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Private</title>
    <style>
        :root {
            --wa-teal: #075e54;
            --wa-teal-light: #128c7e;
            --wa-bg: #e5ddd5;
            --wa-sent: #dcf8c6;
            --wa-received: #ffffff;
            --wa-accent: #34b7f1;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif; 
            margin: 0; background: var(--wa-bg); height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Password Overlay */
        #password-overlay { 
            position: fixed; inset: 0; background: white; z-index: 5000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }

        /* Header */
        header {
            background: var(--wa-teal); color: white; padding: 10px 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100;
        }
        .user-info b { font-size: 17px; display: block; }
        .user-info span { font-size: 12px; opacity: 0.9; }

        /* Chat Area */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 15px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            display: flex; flex-direction: column; gap: 5px;
        }

        /* Bubble Chat */
        .message {
            max-width: 80%; padding: 6px 10px 8px; border-radius: 8px;
            position: relative; font-size: 14.5px; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            word-wrap: break-word; cursor: pointer;
        }
        .sent { align-self: flex-end; background: var(--wa-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--wa-received); border-top-left-radius: 0; }

        .message img { max-width: 100%; border-radius: 5px; display: block; margin-bottom: 5px; }

        .reply-box {
            background: rgba(0,0,0,0.05); border-left: 4px solid var(--wa-teal);
            padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; font-size: 12px;
        }

        .msg-footer {
            display: flex; justify-content: flex-end; font-size: 11px; color: rgba(0,0,0,0.4); margin-top: 3px;
        }
        .sent .msg-footer span { color: var(--wa-accent); margin-left: 3px; font-weight: bold; }

        /* Input Area */
        #input-area { background: #f0f0f0; padding: 8px; display: flex; align-items: center; gap: 8px; }
        .input-wrapper { background: white; flex: 1; border-radius: 25px; display: flex; align-items: center; padding: 0 12px; }
        #msg-input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }
        
        .circle-btn {
            width: 45px; height: 45px; background: var(--wa-teal-light);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; border: none; cursor: pointer; font-size: 20px; flex-shrink: 0;
        }

        /* Preview Photo */
        #preview-overlay {
            position: fixed; inset: 0; background: black; z-index: 3000;
            display: none; flex-direction: column;
        }
        #preview-img { flex: 1; object-fit: contain; }
    </style>
</head>
<body>

    <div id="password-overlay">
        <h2 style="color:var(--wa-teal)">WhatsApp Private</h2>
        <input type="password" id="pass-input" placeholder="Password" style="padding:12px; border-radius:8px; border:1px solid #ccc; text-align:center;">
        <br>
        <button onclick="checkPassword()" class="circle-btn" style="width:120px; border-radius:25px; font-size:16px;">MASUK</button>
    </div>

    <div id="preview-overlay">
        <div style="padding:15px; color:white;"><button onclick="cancelPreview()" style="background:none; border:none; color:white; font-size:24px;">âœ•</button></div>
        <img id="preview-img" src="">
        <div style="padding:20px; display:flex; gap:10px;">
            <input type="text" id="caption-input" placeholder="Keterangan..." style="flex:1; padding:12px; border-radius:25px; border:none; outline:none;">
            <button class="circle-btn" onclick="confirmSendImage()">âž¤</button>
        </div>
    </div>

    <header>
        <div class="user-info">
            <b id="room-name">Memuat...</b>
            <span id="status-label">Menghubungkan...</span>
        </div>
        <button onclick="clearChat()" style="background:none; border:none; color:white; font-size:13px; font-weight:bold;">HAPUS CHAT</button>
    </header>

    <div id="chat-container"></div>

    <div id="reply-bar" style="display:none; background:#eee; padding:8px 15px; border-left:5px solid var(--wa-teal);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="reply-text-display" style="font-size:12px; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
            <button onclick="cancelReply()" style="border:none; background:none; font-size:16px;">âœ•</button>
        </div>
    </div>

    <div id="input-area">
        <div class="input-wrapper">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:20px; cursor:pointer;">ðŸ“·</button>
            <input type="file" id="file-input" accept="image/*" style="display:none">
            <input type="text" id="msg-input" placeholder="Ketik pesan..." autocomplete="off">
        </div>
        <button id="mic-btn" class="circle-btn" onclick="handleVoiceNote()">ðŸ“ž</button>
        <button id="send-btn" class="circle-btn" onclick="handleSend()" style="display:none">âž¤</button>
    </div>

    <script>
        const PASS = "*123#";
        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room') || 'Utama';
        const myId = 'user_' + Math.random().toString(36).substr(2, 5);

        let renderedIds = new Set();
        let currentReply = null;
        let selectedFile = null;
        let mediaRecorder, audioChunks = [], isRecording = false;

        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('password-overlay').style.display = 'none';
            initApp();
        }

        function checkPassword() {
            if (document.getElementById('pass-input').value === PASS) {
                sessionStorage.setItem('isLoggedIn', 'true');
                document.getElementById('password-overlay').style.display = 'none';
                initApp();
            } else { alert("Password salah!"); }
        }

        document.getElementById('msg-input').addEventListener('input', (e) => {
            const hasText = e.target.value.trim().length > 0;
            document.getElementById('mic-btn').style.display = hasText ? 'none' : 'flex';
            document.getElementById('send-btn').style.display = hasText ? 'flex' : 'none';
        });

        // --- FUNGSI KOMPRESI FOTO ---
        async function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Standar WhatsApp
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_WIDTH) { width *= MAX_WIDTH / height; height = MAX_WIDTH; }
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Kualitas 70%
                };
            });
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('preview-img').src = ev.target.result;
                document.getElementById('preview-overlay').style.display = 'flex';
            };
            reader.readAsDataURL(selectedFile);
        });

        function cancelPreview() { 
            document.getElementById('preview-overlay').style.display = 'none'; 
            selectedFile = null;
            document.getElementById('file-input').value = '';
        }

        async function confirmSendImage() {
            const caption = document.getElementById('caption-input').value;
            const reader = new FileReader();
            reader.readAsDataURL(selectedFile);
            reader.onload = async () => {
                const compressedBase64 = await compressImage(reader.result);
                await sendData(caption, compressedBase64, null);
                cancelPreview();
                document.getElementById('caption-input').value = '';
            };
        }

        async function handleVoiceNote() {
            const btn = document.getElementById('mic-btn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => sendData(null, null, reader.result);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    btn.innerHTML = "âº"; btn.style.background = "red";
                } catch(e) { alert("Mic ditolak!"); }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.innerHTML = "ðŸ“ž"; btn.style.background = "var(--wa-teal-light)";
            }
        }

        function prepareReply(text, sender) {
            currentReply = { text: text.substring(0, 50), sender };
            document.getElementById('reply-text-display').innerText = `${sender}: ${currentReply.text}`;
            document.getElementById('reply-bar').style.display = 'block';
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            currentReply = null;
            document.getElementById('reply-bar').style.display = 'none';
        }

        async function handleSend() {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            await sendData(input.value, null, null);
            input.value = '';
            document.getElementById('mic-btn').style.display = 'flex';
            document.getElementById('send-btn').style.display = 'none';
        }

        async function sendData(text, image, audio) {
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room, text, image, audio, senderId: myId, reply: currentReply })
            });
            cancelReply();
            fetchMessages();
        }

        function append(msg) {
            const id = msg.senderId + msg.time + (msg.text || '') + (msg.audio ? 'aud' : '') + (msg.image ? 'img' : '');
            if (renderedIds.has(id)) return;
            renderedIds.add(id);

            const container = document.getElementById('chat-container');
            const isMe = msg.senderId === myId;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.onclick = () => prepareReply(msg.text || (msg.image ? "Foto" : "Suara"), isMe ? "Anda" : "Teman");

            let html = "";
            if (msg.reply) html += `<div class="reply-box"><b>${msg.reply.sender}</b><br>${msg.reply.text}</div>`;
            if (msg.image) html += `<img src="${msg.image}">`;
            if (msg.audio) html += `<audio controls src="${msg.audio}" style="width:180px; height:30px;"></audio>`;
            if (msg.text) html += `<div>${msg.text}</div>`;
            html += `<div class="msg-footer">${msg.time} ${isMe ? '<span>âœ“âœ“</span>' : ''}</div>`;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function fetchMessages() {
            try {
                const res = await fetch(`/api/messages?room=${room}`);
                const data = await res.json();
                data.forEach(m => append(m));
            } catch (e) {}
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/heartbeat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: myId, room })
                });
                const data = await res.json();
                document.getElementById('status-label').innerText = `${data.onlineCount} Orang Online`;
            } catch (e) {}
        }

        function initApp() {
            document.getElementById('room-name').innerText = room;
            fetchMessages();
            setInterval(fetchMessages, 2000);
            setInterval(updateStatus, 5000);
        }

        async function clearChat() {
            if (confirm("Hapus semua chat secara permanen?")) {
                await fetch(`/api/messages?room=${room}`, { method: 'DELETE' });
                document.getElementById('chat-container').innerHTML = '';
                renderedIds.clear();
            }
        }

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
