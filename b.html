<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WhatsApp - User B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; height: 100dvh; width: 100vw; margin: 0; overflow: hidden; display: flex; justify-content: center; }
        #chatContainer { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: rgba(229, 221, 213, 0.9); background-blend-mode: overlay; }
        .bubble { padding: 8px 12px; border-radius: 8px; margin-bottom: 4px; max-width: 85%; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); position: relative; font-size: 15px; word-wrap: break-word; }
        .mine { background: #dcf8c6; align-self: flex-end; }
        .theirs { background: white; align-self: flex-start; }
        .recording-active { background-color: #ff4b2b !important; transform: scale(1.1); transition: 0.3s; }
    </style>
</head>
<body class="w-full">
    <div id="loginOverlay" class="fixed inset-0 bg-[#075e54] z-[100] flex flex-col items-center justify-center p-6 text-white text-center">
        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 text-[#075e54]">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
        </div>
        <h1 class="text-xl font-bold mb-6">Masukkan Sandi User B</h1>
        <input type="password" id="passInp" class="w-full max-w-xs p-3 rounded-lg text-black text-center mb-4 outline-none focus:ring-2 ring-blue-500" placeholder="Sandi (12345)">
        <button onclick="checkPass()" class="w-full max-w-xs bg-blue-600 text-white font-bold py-3 rounded-lg active:scale-95 transition-transform">BUKA CHAT</button>
    </div>

    <div id="mainApp" class="hidden w-full h-full flex flex-col bg-[#e5ddd5] overflow-hidden">
        <div class="bg-[#075e54] text-white p-4 flex items-center justify-between z-10 shrink-0 shadow-md">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold text-lg text-white">A</div>
                <div><h2 class="font-bold text-base">User A</h2><div class="flex items-center gap-1.5"><div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-gray-400 border border-white/20"></div><p id="status" class="text-xs text-gray-200">Offline</p></div></div>
            </div>
            <button onclick="clearChat()" class="text-xs bg-white/10 px-3 py-2 rounded-lg active:bg-white/20">Hapus Chat</button>
        </div>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2"><div id="chatBox" class="flex flex-col space-y-2"></div></div>

        <div id="previewArea" style="display: none;" class="p-3 bg-white border-t flex flex-col gap-2 shrink-0">
            <div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-500">Pratinjau Media</span><button onclick="cancelPreview()" class="text-red-500 text-xs font-bold">BATAL</button></div>
            <img id="imgPreview" class="max-h-48 rounded-lg mx-auto shadow-md" style="display: none;"><video id="vidPreview" class="max-h-48 rounded-lg mx-auto shadow-md" style="display: none;" controls></video>
        </div>

        <div id="emojiPanel" style="display: none;" class="grid grid-cols-8 p-3 bg-white h-48 overflow-y-auto border-t shrink-0"></div>

        <div class="bg-[#f0f0f0] p-2 flex items-center gap-2 shrink-0 pb-[calc(8px+env(safe-area-inset-bottom))]">
            <div class="flex bg-white rounded-full flex-1 items-center px-2 shadow-sm border border-gray-200 py-0.5 overflow-hidden">
                <button onclick="toggleEmoji()" class="text-gray-500 p-2 shrink-0 active:bg-gray-100 rounded-full"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5s.67 1.5 1.5 1.5zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></button>
                <input type="text" id="msgInp" placeholder="Ketik pesan" class="flex-1 outline-none p-2 text-base bg-transparent min-w-0">
                <label id="attachBtn" class="cursor-pointer text-gray-500 p-2 shrink-0 active:bg-gray-100 rounded-full"><input type="file" id="fileInp" class="hidden" accept="image/*,video/*" onchange="handlePreview(this)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></label>
                <button id="camBtn" onclick="document.getElementById('fileInp').click()" class="text-gray-500 p-2 shrink-0 active:bg-gray-100 rounded-full"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg></button>
            </div>
            <div class="flex shrink-0">
                <button id="micBtn" onmousedown="startVN()" onmouseup="stopVN()" ontouchstart="startVN()" ontouchend="stopVN()" class="bg-[#00a884] text-white p-3 rounded-full shadow-lg active:scale-90 transition-transform flex items-center justify-center"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                <button id="sendBtn" style="display: none;" onclick="send()" class="bg-[#00a884] text-white p-3 rounded-full shadow-lg active:scale-90 transition-transform flex items-center justify-center"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
        const SAYA = "USER_B", LAWAN = "USER_A", SANDI = "000#";
        const inp = document.getElementById('msgInp');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const attachBtn = document.getElementById('attachBtn');
        const camBtn = document.getElementById('camBtn');
        let mediaRecorder, chunks = [], currentMedia = null;

        function checkPass() {
            if(document.getElementById('passInp').value === SANDI) {
                document.getElementById('loginOverlay').style.display = "none";
                document.getElementById('mainApp').classList.remove('hidden');
                fetchMsg();
            } else { alert("Sandi Salah!"); }
        }

        function updateInputUI() {
            const hasText = inp.value.trim().length > 0;
            const hasMedia = currentMedia !== null;
            if (hasText || hasMedia) { sendBtn.style.display = "flex"; micBtn.style.display = "none"; attachBtn.style.display = "none"; camBtn.style.display = "none"; } 
            else { sendBtn.style.display = "none"; micBtn.style.display = "flex"; attachBtn.style.display = "flex"; camBtn.style.display = "flex"; }
        }
        inp.addEventListener('input', updateInputUI);

        async function fetchMsg() {
            try {
                const res = await fetch('/api/messages');
                const data = await res.json();
                document.getElementById('chatBox').innerHTML = data.map(m => `
                    <div class="bubble ${m.senderId === SAYA ? 'mine' : 'theirs'}">
                        ${m.image ? (m.image.includes('video') ? `<video src="${m.image}" controls class="max-w-full rounded-md">` : `<img src="${m.image}" class="max-w-full rounded-md">`) : ''}
                        ${m.audio ? `<audio src="${m.audio}" controls class="w-48 h-10"></audio>` : ''}
                        <p class="${m.text ? 'mt-1' : ''}">${m.text || ''}</p>
                        <span class="text-[10px] block text-right opacity-60 mt-1">${m.time}</span>
                    </div>`).join('');
                const container = document.getElementById('chatContainer'); container.scrollTop = container.scrollHeight;
            } catch (e) {}
        }

        function handlePreview(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentMedia = e.target.result; document.getElementById('previewArea').style.display = "block"; updateInputUI();
                const target = file.type.includes('image') ? 'imgPreview' : 'vidPreview';
                document.getElementById('imgPreview').style.display = file.type.includes('image') ? "block" : "none";
                document.getElementById('vidPreview').style.display = file.type.includes('video') ? "block" : "none";
                document.getElementById(target).src = currentMedia;
            };
            reader.readAsDataURL(file);
        }

        function cancelPreview() { currentMedia = null; document.getElementById('fileInp').value = ""; document.getElementById('previewArea').style.display = "none"; updateInputUI(); }

        async function send() {
            const txt = inp.value; if(!txt.trim() && !currentMedia) return;
            await fetch('/api/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ senderId:SAYA, text:txt, image:currentMedia }) });
            inp.value = ""; cancelPreview(); fetchMsg(); updateInputUI();
        }

        async function startVN() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream); chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const r = new FileReader(); r.readAsDataURL(blob);
                    r.onloadend = async () => { await fetch('/api/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ senderId:SAYA, audio:r.result }) }); fetchMsg(); };
                };
                mediaRecorder.start(); micBtn.classList.add('recording-active');
            } catch(e) { alert("Mic tidak diizinkan"); }
        }
        function stopVN() { if(mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); micBtn.classList.remove('recording-active'); } }

        function toggleEmoji() {
            const p = document.getElementById('emojiPanel');
            p.style.display = p.style.display === "none" ? "grid" : "none";
            if(p.innerHTML==="") ["ðŸ˜€","ðŸ˜‚","ðŸ˜Š","ðŸ˜","ðŸ¤”","ðŸ‘","ðŸ™","ðŸ”¥","â¤ï¸","âœ¨","ðŸ¤£","ðŸ˜­","ðŸ™Œ"].forEach(e => {
                const b = document.createElement('button'); b.innerText = e; b.className="text-2xl p-2 active:bg-gray-100 rounded-lg";
                b.onclick = () => { inp.value += e; inp.focus(); updateInputUI(); }; p.appendChild(b);
            });
        }

        async function clearChat() { if(confirm("Hapus semua chat?")) { await fetch('/api/messages', { method: 'DELETE' }); fetchMsg(); } }

        setInterval(async () => {
            try {
                const res = await fetch('/api/heartbeat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:SAYA }) });
                const data = await res.json();
                const isOnline = data.usersOnline && data.usersOnline.includes(LAWAN);
                document.getElementById('status').innerText = isOnline ? "Online" : "Offline";
                document.getElementById('statusDot').className = `w-2.5 h-2.5 rounded-full border border-white/20 ${isOnline ? 'bg-green-400' : 'bg-gray-400'}`;
                fetchMsg();
            } catch (e) {}
        }, 3000);
    </script>
</body>
</html>